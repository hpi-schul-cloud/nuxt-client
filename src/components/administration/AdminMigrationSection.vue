<template>
	<div>
		<div v-if="!isGracePeriodExpired" data-testId="migration-control-section">
			<RenderHTML
				data-testid="text-description"
				:html="
					t('components.administration.adminMigrationSection.description', {
						supportLink,
					})
				"
				component="p"
			/>
			<div v-if="isStartButtonVisible">
				<v-alert type="info">
					<div class="alert-text">
						<RenderHTML
							data-testid="migration-info-text"
							:html="
								t('components.administration.adminMigrationSection.infoText')
							"
							component="span"
						/>
					</div>
				</v-alert>
			</div>
			<div v-else-if="isMigrationActive">
				<v-alert type="info">
					<div class="alert-text">
						<RenderHTML
							data-testid="migration-active-status"
							:html="
								t(
									'components.administration.adminMigrationSection.migrationActive'
								)
							"
							component="span"
						/>
					</div>
				</v-alert>
			</div>
			<v-btn
				v-if="isStartButtonVisible"
				class="my-4 button-start"
				color="primary"
				variant="flat"
				:disabled="!officialSchoolNumber"
				data-testid="migration-start-button"
				@click="onToggleShowStartWarning"
			>
				{{
					t(
						"components.administration.adminMigrationSection.migrationEnableButton.label"
					)
				}}
			</v-btn>
			<v-btn
				v-if="isEndButtonVisible"
				class="my-4 button-end"
				color="primary"
				variant="flat"
				:disabled="!isMigrationActive"
				data-testid="migration-end-button"
				@click="onToggleShowEndWarning"
			>
				{{
					t(
						"components.administration.adminMigrationSection.migrationEndButton.label"
					)
				}}
			</v-btn>
			<v-switch
				v-show="isShowMandatorySwitch"
				:label="
					t(
						'components.administration.adminMigrationSection.mandatorySwitch.label'
					)
				"
				:disabled="!isMigrationActive"
				:true-value="true"
				:false-value="false"
				:true-icon="mdiCheck"
				:model-value="isMigrationMandatory"
				class="ml-1"
				data-testid="migration-mandatory-switch"
				@update:model-value="setMigrationMandatory(!isMigrationMandatory)"
			/>
		</div>

		<migration-warning-card
			value="start"
			v-if="isStartWarningVisible"
			data-testid="migration-start-warning-card"
			@start="onToggleShowStartWarning"
			@set="onStartMigration()"
		/>

		<migration-warning-card
			value="end"
			v-if="isEndWarningVisible"
			data-testid="migration-end-warning-card"
			@end="onToggleShowEndWarning"
			@set="onCloseMigration()"
		/>

		<RenderHTML
			v-if="
				userLoginMigration &&
				userLoginMigration.closedAt &&
				userLoginMigration.finishedAt
			"
			class="migration-completion-date"
			data-testid="migration-finished-timestamp"
			:html="
				t(latestMigration, {
					date: dayjs(userLoginMigration.closedAt).format('DD.MM.YYYY'),
					time: dayjs(userLoginMigration.closedAt).format('HH:mm'),
					finishDate: dayjs(userLoginMigration.finishedAt).format('DD.MM.YYYY'),
					finishTime: dayjs(userLoginMigration.finishedAt).format('HH:mm'),
				})
			"
			component="p"
		/>

		<v-switch
			v-if="!isGracePeriodExpired && globalFeatureEnableLdapSyncDuringMigration"
			:label="
				t(
					'components.administration.adminMigrationSection.enableSyncDuringMigration.label'
				)
			"
			:disabled="!isMigrationActive"
			v-model="school.features.enableLdapSyncDuringMigration"
			class="ml-1"
			:true-icon="mdiCheck"
			data-testid="enable-sync-during-migration-switch"
			@update:model-value="setSchoolFeatures"
		/>

		<template v-if="showMigrationWizard">
			<v-btn
				:disabled="!isMigrationActive || !isSchoolMigrated"
				class="my-4"
				color="primary"
				variant="flat"
				data-testid="migration-wizard-button"
				:to="{ name: 'administration-migration' }"
			>
				{{
					t(
						"components.administration.adminMigrationSection.migrationWizardButton.label"
					)
				}}
			</v-btn>
			<p>
				{{
					t(
						"components.administration.adminMigrationSection.migrationWizardButton.description"
					)
				}}
			</p>
		</template>

		<v-switch
			v-if="globalFeatureShowOutdatedUsers"
			:label="
				t(
					'components.administration.adminMigrationSection.showOutdatedUsers.label'
				)
			"
			v-model="school.features.showOutdatedUsers"
			class="ml-1"
			:true-icon="mdiCheck"
			data-testid="show-outdated-users-switch"
			@update:model-value="setSchoolFeatures"
		/>
		<p
			v-if="globalFeatureShowOutdatedUsers"
			data-testid="show-outdated-users-description"
		>
			{{
				t(
					"components.administration.adminMigrationSection.showOutdatedUsers.description"
				)
			}}
		</p>
	</div>
</template>

<script lang="ts">
import { useI18n } from "vue-i18n";
import { School } from "@/store/types/schools";
import { UserLoginMigration } from "@/store/user-login-migration";
import {
	ENV_CONFIG_MODULE_KEY,
	injectStrict,
	SCHOOLS_MODULE_KEY,
	USER_LOGIN_MIGRATION_MODULE_KEY,
} from "@/utils/inject";
import { RenderHTML } from "@feature-render-html";
import dayjs from "dayjs";
import {
	computed,
	ComputedRef,
	defineComponent,
	onMounted,
	ref,
	Ref,
} from "vue";
import MigrationWarningCard from "./MigrationWarningCard.vue";
import { mdiCheck } from "@/components/icons/material";

export default defineComponent({
	name: "AdminMigrationSection",
	components: {
		MigrationWarningCard,
		RenderHTML,
	},
	setup() {
		const { t } = useI18n();
		const envConfigModule = injectStrict(ENV_CONFIG_MODULE_KEY);
		const schoolsModule = injectStrict(SCHOOLS_MODULE_KEY);
		const userLoginMigrationModule = injectStrict(
			USER_LOGIN_MIGRATION_MODULE_KEY
		);

		onMounted(async () => {
			await userLoginMigrationModule.fetchLatestUserLoginMigrationForSchool();
		});

		const userLoginMigration: ComputedRef<UserLoginMigration | undefined> =
			computed(() => userLoginMigrationModule.getUserLoginMigration);

		const isMigrationActive: ComputedRef<boolean> = computed(
			() =>
				!!userLoginMigration.value?.startedAt &&
				!userLoginMigration.value.closedAt
		);

		const isMigrationMandatory: ComputedRef<boolean> = computed(
			() => !!userLoginMigration.value?.mandatorySince
		);

		const onStartMigration = () => {
			if (userLoginMigration.value) {
				userLoginMigrationModule.restartUserLoginMigration();
			} else {
				userLoginMigrationModule.startUserLoginMigration();
			}
		};

		const setMigrationMandatory = (mandatory: boolean) => {
			userLoginMigrationModule.setUserLoginMigrationMandatory(mandatory);
		};

		const onCloseMigration = () => {
			userLoginMigrationModule.closeUserLoginMigration();
		};

		const school: ComputedRef<School> = computed(() => schoolsModule.getSchool);

		const isEndWarningVisible: Ref<boolean> = ref(false);

		const onToggleShowEndWarning = () => {
			isEndWarningVisible.value = !isEndWarningVisible.value;
		};

		const isStartWarningVisible: Ref<boolean> = ref(false);

		const onToggleShowStartWarning = () => {
			isStartWarningVisible.value = !isStartWarningVisible.value;
		};

		const isEndButtonVisible: ComputedRef<boolean> = computed(
			() =>
				isMigrationActive.value &&
				!isEndWarningVisible.value &&
				!isStartWarningVisible.value
		);

		const isStartButtonVisible: ComputedRef<boolean> = computed(
			() =>
				!isEndButtonVisible.value &&
				!isEndWarningVisible.value &&
				!isStartWarningVisible.value
		);

		const isShowMandatorySwitch: ComputedRef<boolean> = computed(
			() => !isEndWarningVisible.value && !isStartWarningVisible.value
		);

		const isGracePeriodExpired: ComputedRef<boolean> = computed(() => {
			if (userLoginMigration.value?.finishedAt) {
				return (
					Date.now() >= new Date(userLoginMigration.value.finishedAt).getTime()
				);
			}

			return false;
		});

		const latestMigration: ComputedRef<string> = computed(() => {
			if (isGracePeriodExpired.value) {
				return "components.administration.adminMigrationSection.oauthMigrationFinished.textComplete";
			} else {
				return "components.administration.adminMigrationSection.oauthMigrationFinished.text";
			}
		});

		const officialSchoolNumber: ComputedRef<string | undefined> = computed(
			() => schoolsModule.getSchool.officialSchoolNumber
		);

		const getSubject = (): string => {
			const subject = encodeURIComponent(
				`Schule mit der Nummer: ${
					officialSchoolNumber.value ?? "???"
				} soll keine Migration durchführen, Schuladministrator bittet um Unterstützung!`
			);

			return subject;
		};

		const supportLink: ComputedRef<string> = computed(
			() =>
				`mailto:${
					envConfigModule.getAccessibilityReportEmail
				}?subject=${getSubject()}`
		);

		const globalFeatureEnableLdapSyncDuringMigration: ComputedRef<boolean> =
			computed(() => envConfigModule.getEnableLdapSyncDuringMigration);

		const globalFeatureShowOutdatedUsers: ComputedRef<boolean> = computed(
			() => envConfigModule.getShowOutdatedUsers
		);

		const isSchoolMigrated: ComputedRef<boolean> = computed(() => {
			let hasTargetSystem = false;

			if (userLoginMigration.value?.targetSystemId) {
				hasTargetSystem = schoolsModule.getSchool.systemIds.includes(
					userLoginMigration.value.targetSystemId
				);
			}

			return hasTargetSystem;
		});

		const showMigrationWizard: ComputedRef<boolean> = computed(
			() => !!envConfigModule.getEnv.FEATURE_SHOW_MIGRATION_WIZARD
		);

		const setSchoolFeatures = async () => {
			await schoolsModule.update({
				id: school.value.id,
				features: school.value.features,
			});
		};

		return {
			userLoginMigration,
			onStartMigration,
			setMigrationMandatory,
			onCloseMigration,
			t,
			isEndWarningVisible,
			onToggleShowEndWarning,
			isStartWarningVisible,
			onToggleShowStartWarning,
			isStartButtonVisible,
			isEndButtonVisible,
			isShowMandatorySwitch,
			isGracePeriodExpired,
			latestMigration,
			dayjs,
			supportLink,
			school,
			setSchoolFeatures,
			globalFeatureShowOutdatedUsers,
			globalFeatureEnableLdapSyncDuringMigration,
			officialSchoolNumber,
			isMigrationActive,
			isMigrationMandatory,
			mdiCheck,
			showMigrationWizard,
			isSchoolMigrated,
		};
	},
});
</script>

<style lang="scss" scoped>
.alert-text {
	color: rgba(var(--v-theme-black)) !important;
	line-height: var(--line-height-lg) !important;
}
</style>
