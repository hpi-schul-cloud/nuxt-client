<template>
	<v-custom-dialog
		:is-open="isOpen"
		:size="425"
		@dialog-closed="cancel"
		has-buttons
		confirm-btn-title-key="pages.administration.school.index.termsOfUse.replace"
		confirm-btn-icon="$mdiFileReplaceOutline"
		:confirm-btn-disabled="!isValid"
		@dialog-confirmed="submit"
	>
		<template #title>
			<h4 class="text-h4 mt-0">
				{{ t("common.words.termsOfUse") }}
			</h4>
		</template>
		<template #content>
			<v-form ref="termsForm" v-model="isValid">
				<v-alert variant="tonal" type="warning" class="mb-10" icon="$mdiAlert">
					<div class="alert-text">
						{{
							t(
								"pages.administration.school.index.termsOfUse.longText.willReplaceAndSendConsent"
							)
						}}
					</div>
				</v-alert>
				<v-file-input
					ref="input-file"
					class="input-file mb-2"
					data-testid="input-file"
					v-model="files"
					:multiple="false"
					density="compact"
					variant="underlined"
					accept="application/pdf"
					truncate-length="30"
					:label="
						t('pages.administration.school.index.termsOfUse.labels.uploadFile')
					"
					:hint="
						t('pages.administration.school.index.termsOfUse.hints.uploadFile')
					"
					:persistent-hint="true"
					:rules="[rules.required, rules.mustBePdf, rules.maxSize(4194304)]"
					@blur="onBlur"
				>
					<template v-slot:append-inner>
						<v-icon
							v-if="!isValid && isTouched"
							color="rgba(var(--v-theme-error))"
							data-testid="warning-icon"
							>$mdiAlert</v-icon
						>
					</template>
				</v-file-input>
			</v-form>
		</template>
	</v-custom-dialog>
</template>

<script lang="ts">
import vCustomDialog from "@/components/organisms/vCustomDialog.vue";
import { computed, ComputedRef, defineComponent, ref, Ref } from "vue";
import {
	injectStrict,
	NOTIFIER_MODULE_KEY,
	SCHOOLS_MODULE_KEY,
	TERMS_OF_USE_MODULE_KEY,
} from "@/utils/inject";
import { School } from "@/store/types/schools";
import { currentDate } from "@/plugins/datetime";
import { toBase64 } from "@/utils/fileHelper";
import { CreateConsentVersionPayload } from "@/store/types/consent-version";
import { useI18n } from "vue-i18n";
import { reactive } from "vue";

export default defineComponent({
	name: "SchoolTermsFormDialog",
	components: {
		vCustomDialog,
	},
	emits: ["close"],
	props: {
		isOpen: {
			type: Boolean,
			required: true,
		},
	},
	setup(props, { emit }) {
		const { t } = useI18n();
		const termsOfUseModule = injectStrict(TERMS_OF_USE_MODULE_KEY);
		const notifierModule = injectStrict(NOTIFIER_MODULE_KEY);
		const schoolsModule = injectStrict(SCHOOLS_MODULE_KEY);

		const termsForm: Ref = ref(null);
		const isFormValid: Ref<boolean> = ref(false);
		const isFormTouched: Ref<boolean> = ref(false);
		const termsFiles = reactive<File[]>([]);

		const school: ComputedRef<School> = computed(() => schoolsModule.getSchool);

		const validationRules = {
			required: (value: string) => !!value || t("common.validation.required"),
			mustBePdf: (value: File) =>
				!value ||
				value.type === "application/pdf" ||
				t("pages.administration.school.index.termsOfUse.validation.notPdf"),
			maxSize: (bytes: number) => (value: File) =>
				!value ||
				value.size <= bytes ||
				t("pages.administration.school.index.termsOfUse.validation.fileTooBig"),
		};

		const onBlur = () => {
			isFormTouched.value = true;
		};

		const resetForm = () => {
			termsForm.value.reset();
			isFormValid.value = false;
			isFormTouched.value = false;
		};

		const cancel = () => {
			resetForm();
			emit("close");
		};

		const submit = async () => {
			if (isFormValid.value) {
				const newConsentVersion: CreateConsentVersionPayload = {
					schoolId: school.value.id,
					title: t("pages.administration.school.index.termsOfUse.fileName"),
					consentText: "",
					consentTypes: ["termsOfUse"],
					publishedAt: currentDate().toString(),
					consentData: (await toBase64(termsFiles[0])) as string,
				};

				emit("close");
				await termsOfUseModule.createTermsOfUse(newConsentVersion);

				notifierModule.show({
					text: t("pages.administration.school.index.termsOfUse.success"),
					status: "success",
					timeout: 10000,
				});

				resetForm();
			}
		};

		return {
			t,
			files: termsFiles,
			rules: validationRules,
			cancel,
			submit,
			onBlur,
			isValid: isFormValid,
			isTouched: isFormTouched,
			termsForm,
			school,
		};
	},
});
</script>

<style lang="scss" scoped>
.alert-text {
	color: rgba(var(--v-theme-black)) !important;
	line-height: var(--line-height-lg) !important;
}

.button-left {
	width: 25%;
	text-align: left;
}

.button-right {
	display: inline-block;
	width: 75%;
	text-align: right;
}

.button-section {
	margin-bottom: calc(var(--space-base-vuetify) * 2);
}

.button-section > button {
	margin-left: calc(var(--space-base-vuetify) * 2);
}
</style>
