<template>
	<DefaultWireframe
		max-width="full"
		:breadcrumbs="breadcrumbs"
		:fabItems="fabItems"
		@onFabItemClick="fabItemClickHandler"
	>
		<template #header>
			<div class="d-flex align-items-center">
				<h1 class="text-h3 mb-4" data-testid="room-title">
					{{ roomTitle }}
				</h1>
				<RoomMenu
					v-if="isMenuEnabled"
					@room:edit="onEdit"
					@room:manage-members="onManageMembers"
					@room:delete="onDelete"
				/>
			</div>
		</template>
		<BoardGrid :boards="roomBoards" />
		<ConfirmationDialog />
		<SelectBoardLayoutDialog
			v-if="boardLayoutsEnabled && canCreateRoom"
			v-model="boardLayoutDialogIsOpen"
			@select="onCreateBoard"
		/>
	</DefaultWireframe>
</template>

<script setup lang="ts">
import { Breadcrumb } from "@/components/templates/default-wireframe.types";
import DefaultWireframe from "@/components/templates/DefaultWireframe.vue";
import { BoardLayout } from "@/serverApi/v3";
import { ENV_CONFIG_MODULE_KEY, injectStrict } from "@/utils/inject";
import { buildPageTitle } from "@/utils/pageTitle";
import { useRoomDetailsStore, useRoomsState } from "@data-room";
import { BoardGrid, RoomMenu, useRoomAuthorization } from "@feature-room";
import {
	mdiPlus,
	mdiViewDashboardOutline,
	mdiViewGridPlusOutline,
} from "@icons/material";
import {
	ConfirmationDialog,
	useDeleteConfirmationDialog,
} from "@ui-confirmation-dialog";
import { SelectBoardLayoutDialog } from "@ui-room-details";
import { useTitle } from "@vueuse/core";
import { storeToRefs } from "pinia";
import { computed, ComputedRef, ref } from "vue";
import { useI18n } from "vue-i18n";
import { useRouter } from "vue-router";

const router = useRouter();
const { t } = useI18n();
const envConfigModule = injectStrict(ENV_CONFIG_MODULE_KEY);

const { deleteRoom } = useRoomsState();
const { askDeleteConfirmation } = useDeleteConfirmationDialog();

const roomDetailsStore = useRoomDetailsStore();
const { room, roomBoards } = storeToRefs(roomDetailsStore);
const { createBoard } = roomDetailsStore;

const pageTitle = computed(() =>
	buildPageTitle(`${room.value?.name} - ${t("pages.roomDetails.title")}`)
);
useTitle(pageTitle);

const { canCreateRoom, canEditRoom, canDeleteRoom } =
	useRoomAuthorization(room);

const roomTitle = computed(() => {
	return room.value ? room.value.name : t("pages.roomDetails.title");
});

const boardLayoutsEnabled = computed(
	() => envConfigModule.getEnv.FEATURE_BOARD_LAYOUT_ENABLED
);

const isMenuEnabled = computed(() => canEditRoom.value || canDeleteRoom.value);
const boardLayoutDialogIsOpen = ref(false);

const breadcrumbs: ComputedRef<Breadcrumb[]> = computed(() => {
	return [
		{
			title: t("pages.rooms.title"),
			to: "/rooms",
		},
		{
			title: roomTitle.value,
			disabled: true,
		},
	];
});

const fabItems = computed(() => {
	if (!canCreateRoom.value) return undefined;

	const actions = [];

	if (boardLayoutsEnabled.value) {
		actions.push({
			label: t("pages.courseRoomDetails.fab.add.board"),
			icon: mdiViewGridPlusOutline,
			customEvent: "board-type-dialog-open",
			dataTestId: "fab_button_add_board",
			ariaLabel: t("pages.courseRoomDetails.fab.add.board"),
		});
	} else {
		actions.push({
			label: t("pages.courseRoomDetails.fab.add.columnBoard"),
			icon: mdiViewDashboardOutline,
			customEvent: "board-create",
			dataTestId: "fab_button_add_column_board",
			ariaLabel: t("pages.courseRoomDetails.fab.add.columnBoard"),
		});
	}

	const items = {
		icon: mdiPlus,
		title: t("common.actions.create"),
		ariaLabel: t("common.actions.create"),
		dataTestId: "add-content-button",
		actions: actions,
	};

	return items;
});

const fabItemClickHandler = (event: string) => {
	if (event === "board-type-dialog-open") {
		boardLayoutDialogIsOpen.value = true;
	} else if (event === "board-create") {
		onCreateBoard(BoardLayout.Columns);
	}
};

const onEdit = () => {
	if (!room.value) return;

	router.push({
		name: "room-edit",
		params: {
			id: room.value.id,
		},
	});
};

const onManageMembers = () => {
	if (!room.value) return;

	router.push({
		name: "room-members",
		params: {
			id: room.value.id,
		},
	});
};

const onDelete = async () => {
	if (!room.value || !canDeleteRoom.value) return;

	const shouldDelete = await askDeleteConfirmation(
		room.value.name,
		"common.labels.room"
	);

	if (shouldDelete) {
		await deleteRoom(room.value.id);
		router.push({
			name: "rooms",
		});
	}
};

const onCreateBoard = async (layout: BoardLayout) => {
	if (!room.value || !canEditRoom.value) return;

	const boardId = await createBoard(
		room.value.id,
		layout,
		t("pages.roomDetails.board.defaultName")
	);

	router.push(`/boards/${boardId}`);
};
</script>
