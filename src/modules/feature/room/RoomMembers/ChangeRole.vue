<template>
	<v-card ref="changeRoleContent">
		<template v-slot:prepend>
			<span ref="textTitle" class="text-h4 mt-2 dialog-title">
				{{ dialogTitle }}
			</span>
		</template>

		<template v-slot:default>
			<div class="ml-6 mr-6 mt-2">
				<div>
					<div v-if="!isHandOverMode" class="mb-4">
						{{ infoText }}
					</div>
					<div>
						<v-radio-group
							v-if="!isHandOverMode"
							v-model="selectedRole"
							hide-details
							class="ml-n2"
						>
							<v-radio
								id="roleChangeViewer"
								:label="t('pages.rooms.members.roomPermissions.viewer')"
								:value="RoleName.Roomviewer"
								color="primary"
							/>
							<label
								for="roleChangeViewer"
								class="ml-10 mt-n2 mb-2 radio-label"
							>
								{{ t("pages.rooms.members.roleChange.Roomviewer.label") }}
							</label>

							<v-radio
								id="roleChangeEditor"
								:label="t('pages.rooms.members.roomPermissions.editor')"
								:value="RoleName.Roomeditor"
								color="primary"
							/>
							<label
								for="roleChangeEditor"
								class="ml-10 mt-n2 mb-2 radio-label"
							>
								{{ t("pages.rooms.members.roleChange.Roomeditor.label") }}
							</label>

							<v-radio
								id="roleChangeAdmin"
								:label="t('pages.rooms.members.roomPermissions.admin')"
								:value="RoleName.Roomadmin"
								color="primary"
							/>
							<label for="roleChangeAdmin" class="ml-10 mt-n2 mb-2 radio-label">
								{{ t("pages.rooms.members.roleChange.Roomadmin.label") }}
							</label>

							<v-radio
								v-if="isChangeRoleOptionVisible"
								id="roleChangeOwner"
								:label="t('pages.rooms.members.roomPermissions.owner')"
								:value="RoleName.Roomowner"
								color="primary"
							/>
							<label
								v-if="isChangeRoleOptionVisible"
								for="roleChangeOwner"
								class="ml-10 mt-n2 mb-2 radio-label"
							>
								{{ t("pages.rooms.members.roleChange.Roomowner.label") }}
								<br />
								{{
									t("pages.rooms.members.roleChange.Roomowner.label.subText")
								}}
							</label>
						</v-radio-group>
						<v-alert
							v-if="selectedRole === RoleName.Roomowner"
							dense
							type="warning"
							:icon="mdiAlert"
							class="mb-2"
							:class="isHandOverMode ? 'ml-0' : 'ml-8'"
						>
							<span class="alert-text">
								{{ alertText }}
							</span>
						</v-alert>
					</div>
				</div>
			</div>
		</template>

		<template v-slot:actions>
			<v-spacer />
			<div class="mr-4 mb-3">
				<v-btn
					class="ms-auto mr-2"
					color="primary"
					:text="t('common.actions.cancel')"
					data-testid="change-role-cancel-btn"
					@click="onCancel"
				/>
				<v-btn
					v-if="!isHandOverMode"
					class="ms-auto"
					color="primary"
					variant="flat"
					:text="t('common.actions.confirm')"
					data-testid="change-role-confirm-btn"
					@click="onConfirm"
				/>
				<v-btn
					v-else
					class="ms-auto"
					color="primary"
					variant="flat"
					text="Übertragen"
					data-testid="change-owner-confirm-btn"
					@click="onChangeOwner"
				/>
			</div>
		</template>
	</v-card>
</template>

<script setup lang="ts">
import { computed, PropType, ref, toRef } from "vue";
import { useI18n } from "vue-i18n";
import {
	ChangeRoomRoleBodyParamsRoleNameEnum as RoleEnum,
	RoleName,
} from "@/serverApi/v3";
import { useFocusTrap } from "@vueuse/integrations/useFocusTrap";
import { VCard, VRadio } from "vuetify/lib/components/index.mjs";
import { RoomMember } from "@data-room";
import { mdiAlert } from "@icons/material";

const props = defineProps({
	members: {
		type: Array as PropType<RoomMember[]>,
		required: true,
		default: () => [],
	},
	roomName: {
		type: String,
		required: true,
	},
	currentUser: {
		type: Object as PropType<RoomMember>,
		required: true,
	},
});
const { t } = useI18n();
const selectedRole = ref<string | null>(null);
const memberToChangeRole = toRef(props, "members")?.value;
const isChangeRoleOptionVisible = computed(() => {
	return (
		props.currentUser?.roomRoleName === RoleName.Roomowner &&
		memberToChangeRole.length === 1
	);
});
const isHandOverMode = ref(false);
const dialogTitle = computed(() =>
	isHandOverMode.value
		? "Raumberechtigung „Besitzen” wirklich übertragen?"
		: t("pages.rooms.members.changePermission")
);

if (memberToChangeRole.length > 1) {
	const roleNamesInProp = memberToChangeRole.map(
		(member) => member.roomRoleName
	);

	if (roleNamesInProp.every((roleName) => roleNamesInProp[0] === roleName)) {
		selectedRole.value = roleNamesInProp[0];
	}
} else {
	selectedRole.value = memberToChangeRole[0]?.roomRoleName;
}

const infoText = computed(() => {
	if (memberToChangeRole.length === 1) {
		const memberName = `${memberToChangeRole[0]?.firstName} ${memberToChangeRole[0]?.lastName}`;
		return t("pages.rooms.members.roleChange.subTitle", {
			memberName,
			roomName: props.roomName,
		});
	}
	return t("pages.rooms.members.roleChange.multipleUser.subTitle", {
		roomName: props.roomName,
	});
});

const alertText = computed(() => {
	const currentUser = `${props.currentUser?.firstName} ${props.currentUser?.lastName}`;
	const member = `${memberToChangeRole[0]?.firstName} ${memberToChangeRole[0]?.lastName}`;
	return isHandOverMode.value
		? t("pages.rooms.members.handOverAlert.confirm.label", {
				currentUser,
				member,
			})
		: t("pages.rooms.members.handOverAlert.label", {
				currentUser,
			});
});

const emit = defineEmits<{
	(e: "confirm", selectedRole: RoleEnum, id?: string): void;
	(e: "change-room-owner", id: string): void;
	(e: "cancel"): void;
}>();

const onConfirm = () => {
	if (!selectedRole.value) return;
	if (selectedRole.value === RoleName.Roomowner) {
		isHandOverMode.value = true;
		return;
	}
	emit(
		"confirm",
		selectedRole.value as RoleEnum,
		props.members.length === 1 ? memberToChangeRole[0].userId : undefined
	);
};

const onChangeOwner = () => {
	emit("change-room-owner", memberToChangeRole[0].userId);
};

const onCancel = () => {
	emit("cancel");
};

const changeRoleContent = ref();
useFocusTrap(changeRoleContent, {
	immediate: true,
});
</script>

<style lang="scss" scoped>
.dialog-title {
	max-width: 480px;
	white-space: normal;
}
.radio-label {
	font-size: 14px;
	line-height: var(--line-height-lg);
	opacity: var(--v-medium-emphasis-opacity);
}

.alert-text {
	color: rgba(var(--v-theme-on-background)) !important;
	line-height: var(--line-height-lg) !important;
}
</style>
