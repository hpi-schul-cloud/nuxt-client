<template>
	<H5PEditorComponent :contentId="contentId" />
</template>

<script lang="ts">
import { notifierModule } from "@/store";
import { $axios } from "@/utils/api";
import { mdiChevronLeft } from "@mdi/js";
import { iframeResizer } from "iframe-resizer";
import { defineComponent, inject, ref } from "vue";
import VueI18n from "vue-i18n";
import { useRoute, useRouter } from "vue-router/composables";

import { H5pEditorApiFactory } from "@/h5pEditorApi/v3";

import H5PEditorComponent from "@/components/h5p/H5PEditor.vue";

type IFrameResizerElement = { iFrameResizer?: { removeListeners: () => void } };

type ParamsValidEvent = CustomEvent;
type ParamsInvalidEvent = CustomEvent<string>;

export default defineComponent({
	name: "H5PEditor",
	components: {
		H5PEditorComponent,
	},
	setup() {
		const i18n = inject<VueI18n | undefined>("i18n");

		if (!i18n) {
			throw new Error("Injection of dependencies failed");
		}

		// TODO: https://ticketsystem.dbildungscloud.de/browse/BC-443
		const t = (key: string, values?: VueI18n.Values | undefined): string => {
			const translateResult = i18n.t(key, values);
			if (typeof translateResult === "string") {
				return translateResult;
			}
			return "unknown translation-key:" + key;
		};

		const route = useRoute();
		const router = useRouter();

		const iframe = ref<HTMLIFrameElement>();

		const contentId = route.params?.id;
		const isInline = !!route.query?.inline;

		const BASE_PATH = "/v3";
		const h5pEditorApi = H5pEditorApiFactory(undefined, BASE_PATH, $axios);

		const iframeSrc = ref<string | undefined>();

		function notifyParent(event: CustomEvent) {
			window.dispatchEvent(event);
		}

		function onInvalidParams(event: ParamsInvalidEvent) {
			notifierModule.show({
				text: t("common.validation.invalid"),
				status: "error",
				timeout: 10000,
			});
		}

		async function onValidParams(event: ParamsValidEvent) {
			try {
				if (contentId) {
					// Save content
					const { data } = await h5pEditorApi.h5PEditorControllerSaveH5pContent(
						contentId,
						event.detail
					);

					notifyParent(
						new CustomEvent("save-content", {
							detail: {
								contentId: data.contentId,
								title: data.metadata.title,
								contentType: data.metadata.mainLibrary,
							},
						})
					);
				} else {
					// Create content
					const { data } =
						await h5pEditorApi.h5PEditorControllerCreateH5pContent(
							event.detail
						);

					notifyParent(
						new CustomEvent("save-content", {
							detail: {
								contentId: data.contentId,
								title: data.metadata.title,
								contentType: data.metadata.mainLibrary,
							},
						})
					);

					router.replace({
						path: `/h5p/editor/${data.contentId}`,
						query: route.query,
					});
				}
			} catch (err) {
				notifierModule.show({
					text: t("common.validation.invalid"),
					status: "error",
					timeout: 10000,
				});
			}
		}

		function validateParams() {
			if (iframe.value) {
				iframe.value.contentWindow?.postMessage("validate-params");
			}
		}

		function goBack() {
			window.close();
		}

		return {
			contentId,
			iframe,
			iframeSrc,
			scriptSrc: "#",
			mdiChevronLeft,
			isInline,
			onValidParams,
			onInvalidParams,
			validateParams,
			goBack,
		};
	},
	directives: {
		h5pResize: {
			bind: function (el: HTMLElement, { value = {} }) {
				el.addEventListener("load", () => iframeResizer(value, el));
			},
			unbind: function (el) {
				(el as IFrameResizerElement).iFrameResizer?.removeListeners();
			},
		},
	},
});
</script>

<style scoped>
.content {
	margin-top: var(--space-xl-3);
}

.editor-iframe {
	height: 100%;
	width: 100%;
	max-width: 960px;
	border: none;
	overflow: auto;
	display: block;
	margin: auto;
}

.column-layout {
	display: flex;
	flex-direction: column;
	align-items: center;
}
</style>
