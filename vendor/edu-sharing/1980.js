"use strict";(self.webpackChunkapp_as_web_component=self.webpackChunkapp_as_web_component||[]).push([[1980],{71980:(w,u,l)=>{l.r(u),l.d(u,{FileUploadProgressDialogComponent:()=>W,FileUploadProgressDialogModule:()=>K});var E=l(50555),T=l(15861),d=l(52081),a=l(81771),h=l(53461),v=l(75222),x=l(96124),_=l(49193),M=l(5253),e=l(65879),I=l(91486),N=l(48098),A=l(36692),f=l(71365),m=l(96814),C=l(56223),O=l(87466);let U=(()=>{class o{transform(t){if(!(0,d.kE)(t))return"invalid value";let n=Math.floor(t/3600),i=Math.floor(t/60%60),r=Math.floor(t%60),s="";return n>0&&(s+=n+" "+this.translate.instant("HOUR"+(1!=n?"S":""))+" "),i>0&&(s+=i+" "+this.translate.instant("MINUTE"+(1!=i?"S":""))+" "),r>0&&(s+=r+" "+this.translate.instant("SECOND"+(1!=r?"S":""))+" "),s.trim()}constructor(t){this.translate=t}static#e=this.\u0275fac=function(n){return new(n||o)(e.Y36(f.sK,16))};static#t=this.\u0275pipe=e.Yjl({name:"formatTime",type:o,pure:!0})}return o})();const S=["existingFiles"];function L(o,p){1&o&&e._UZ(0,"div",15)}function F(o,p){if(1&o&&(e.TgZ(0,"div",16),e._UZ(1,"div",17),e.qZA()),2&o){const t=e.oxw().$implicit;e.xp6(1),e.Udp("width",t.progress.progress+"%"),e.ekj("determinate-finished",t.progress.progress>=100)}}function D(o,p){if(1&o&&(e.TgZ(0,"span",18),e._uU(1),e.ALo(2,"translate"),e.qZA()),2&o){const t=e.oxw().$implicit;e.xp6(1),e.Oqu(e.xi3(2,1,"WORKSPACE.UPLOAD_ERROR."+t.error.key,t.error.variables))}}const R=function(o){return{time:o}};function Z(o,p){if(1&o&&(e.TgZ(0,"span"),e._uU(1),e.ALo(2,"translate"),e.ALo(3,"formatTime"),e.qZA()),2&o){const t=e.oxw(2).$implicit;e.xp6(1),e.Oqu(e.xi3(2,1,"WORKSPACE.UPLOAD_REMAINING",e.VKq(6,R,e.lcZ(3,4,t.progress.remaining))))}}function y(o,p){1&o&&(e.TgZ(0,"span"),e._uU(1),e.ALo(2,"translate"),e.qZA()),2&o&&(e.xp6(1),e.Oqu(e.lcZ(2,1,"WORKSPACE.UPLOAD_FINISHING")))}function Y(o,p){if(1&o&&(e.TgZ(0,"div"),e.YNc(1,Z,4,8,"span",11),e.YNc(2,y,3,3,"span",11),e.TgZ(3,"span",19),e._uU(4),e.ALo(5,"formatSize"),e.ALo(6,"formatSize"),e.qZA()()),2&o){const t=e.oxw().$implicit;e.xp6(1),e.Q6J("ngIf",t.progress.remaining>1),e.xp6(1),e.Q6J("ngIf",t.progress.remaining<=1),e.xp6(2),e.AsE("(",e.lcZ(5,4,t.progress.loaded)," / ",e.lcZ(6,6,t.progress.total),")")}}function b(o,p){1&o&&(e.TgZ(0,"div",20)(1,"i",4),e._uU(2,"done"),e.qZA()())}function X(o,p){1&o&&(e.TgZ(0,"div",21)(1,"i",4),e._uU(2,"close"),e.qZA()())}function Q(o,p){if(1&o&&(e.TgZ(0,"div",2)(1,"div",3)(2,"i",4),e._uU(3,"file_upload"),e.qZA()(),e.TgZ(4,"div",5)(5,"div",6),e._uU(6),e.qZA(),e.YNc(7,L,1,0,"div",7),e.YNc(8,F,2,4,"div",8),e.TgZ(9,"div",9),e.YNc(10,D,3,4,"span",10),e.YNc(11,Y,7,8,"div",11),e.qZA()(),e.TgZ(12,"div",12),e.YNc(13,b,3,0,"div",13),e.YNc(14,X,3,0,"div",14),e.qZA()()),2&o){const t=p.$implicit;e.xp6(6),e.Oqu(t.name),e.xp6(1),e.Q6J("ngIf",t.progress.progress>=0&&t.progress.progress<100),e.xp6(1),e.Q6J("ngIf",t),e.xp6(1),e.Udp("visibility",t.progress.loaded||t.error?"":"hidden"),e.xp6(1),e.Q6J("ngIf",t.error),e.xp6(1),e.Q6J("ngIf",t.progress.loaded),e.xp6(2),e.Q6J("ngIf",!t.progress.loaded&&t.progress.progress>=100),e.xp6(1),e.Q6J("ngIf",!t.progress.loaded&&t.progress.progress<0)}}function J(o,p){if(1&o){const t=e.EpF();e.TgZ(0,"mat-radio-group",22),e.NdJ("ngModelChange",function(i){e.CHM(t);const r=e.oxw();return e.KtG(r.keep=i)}),e.TgZ(1,"mat-radio-button",23),e._uU(2),e.ALo(3,"translate"),e.qZA(),e.TgZ(4,"mat-radio-button",23),e._uU(5),e.ALo(6,"translate"),e.qZA()()}if(2&o){const t=p.$implicit,n=e.oxw();e.Q6J("ngModel",n.keep),e.xp6(1),e.Q6J("value",!1),e.xp6(1),e.hij(" ",e.lcZ(3,5,"WORKSPACE.UPLOAD_EXISTS."+(t?"MULTIPLE":"SINGLE")+"_OVERWRITE")," "),e.xp6(2),e.Q6J("value",!0),e.xp6(1),e.hij(" ",e.lcZ(6,7,"WORKSPACE.UPLOAD_EXISTS."+(t?"MULTIPLE":"SINGLE")+"_KEEP")," ")}}let W=(()=>{class o{constructor(t,n,i,r,s,g){this.data=t,this.dialogRef=n,this.nodeService=i,this.nodeApi=r,this.dialogs=s,this.translate=g,this.progress=[],this.resultList=[],this.error=!1,this.processed=0,this.keep=!0}ngOnInit(){this.dialogRef.patchConfig({buttons:[new a.Qd("CANCEL",{color:"standard"},()=>this._cancel())]});for(const t of this.data.files)this.progress.push({name:t.name,progress:{progress:0}});this._existingNodes().pipe((0,v.w)(t=>"open"!==this.dialogRef.getLifecycleState()?(0,_.of)(!1):(this.existingNodes=t,t.length>0?(0,M.D)(this._openExistingDialog(t)):(0,_.of)(!0)))).subscribe(t=>{t?(this._updateSubtitle(),this._upload(0)):this._cancel()})}_openExistingDialog(t){var n=this;return(0,T.Z)(function*(){const i=t.length>1;let r,s,g;return i?(r=null,s="WORKSPACE.UPLOAD_EXISTS.MULTIPLE",g=null):(r=t[0].name,s="WORKSPACE.UPLOAD_EXISTS.SINGLE",g={fileName:r}),"CANCEL"!==(yield(yield n.dialogs.openGenericDialog({title:"WORKSPACE.UPLOAD_EXISTS.TITLE",message:s,messageParameters:g,contentTemplate:n.existingFilesRef,context:{$implicit:i},buttons:[{label:"CANCEL",config:{color:"standard"}},{label:"WORKSPACE.UPLOAD_EXISTS.UPLOAD",config:{color:"primary"}}]})).afterClosed().toPromise())})()}_cancel(){"open"===this.dialogRef.getLifecycleState()&&this.dialogRef.close(this.resultList.length>0?this.resultList:null)}_existingNodes(){return this.nodeService.getChildren(this._getParent(),[a.u6.FILTER_FILES],{propertyFilter:[]}).pipe((0,x.U)(t=>{let n=[];const i=Array.from(this.data.files).map(s=>s.name),r=t.nodes;for(let s=0;s<r.length;s++){const g=r[s],c=g.name;i.some(P=>P==c)&&n.push(g)}return n}))}_getParent(){return this.data.parent?this.data.parent.ref.id:a.u6.INBOX}_upload(t){if(t>=this.data.files.length)return void(this.error?this.dialogRef.patchConfig({closable:h.IA.Casual}):this._cancel());const n=this.data.files.item(t);if(!n.type&&!n.size)return void setTimeout(()=>{this.progress[t].progress.progress=-1,this.progress[t].error={key:"FORMAT"},this.error=!0,this._upload(t+1)},50);const i=g=>()=>{this.resultList.push(g),this.progress[t].progress.progress=100,this.processed++,this._updateSubtitle(),this._upload(t+1)},r=g=>c=>{this.error=!0,this.progress[t].error=this._mapError(c,g),this.progress[t].progress.progress=-1,this._upload(t+1)},s=this.existingNodes.find(g=>g.name==n.name);s&&!this.keep?this.nodeApi.changeContent(s.ref.repo,s.ref.id,"auto",a.u6.COMMENT_CONTENT_UPDATE,{file:n}).subscribe(i(s),r(s)):this.nodeService.createNode(this._getParent(),a.u6.CCM_TYPE_IO,[],a.bv.createNameProperty(n.name),this.keep).subscribe(g=>{this.nodeService.uploadNodeContent(g.node.ref.id,n,a.u6.COMMENT_MAIN_FILE_UPLOAD,"auto",c=>{c.progress=Math.round(100*c.progress),this.progress[t].progress=c}).subscribe(i(g.node),r(g.node))},r(null))}_updateSubtitle(){this.translate.get("WORKSPACE.UPLOAD_SUBTITLE",{progress:this.processed,total:this.progress.length}).subscribe(t=>this.dialogRef.patchConfig({subtitle:t}))}_mapError(t,n=null){let i,r;if(n&&this.nodeService.deleteNode(n.ref.id,!1).subscribe(()=>{}),a.bv.errorMatchesAny(t,a.u6.CONTENT_VIRUS_SCAN_FAILED_EXCEPTION))i="VIRUS_SCAN_FAILED";else if(a.bv.errorMatchesAny(t,a.u6.CONTENT_VIRUS_EXCEPTION))i="VIRUS";else if(a.bv.errorMatchesAny(t,a.u6.CONTENT_MIMETYPE_VERIFICATION_EXCEPTION))i="MIMETYPE_VERIFICATION";else if(a.bv.errorMatchesAny(t,a.u6.CONTENT_NODE_FILE_SIZE_EXCEEDED_EXCEPTION)){i="FILE_SIZE_EXCEEDED";try{const s=JSON.parse(t.response);r={actualSize:new d.WF(this.translate).transform(s.details.actualSize),maxSize:new d.WF(this.translate).transform(s.details.maxSize)}}catch(s){console.warn(s)}}else i=a.bv.errorMatchesAny(t,a.u6.CONTENT_FILE_EXTENSION_VERIFICATION_EXCEPTION)?"FILETYPE_VERIFICATION":a.bv.errorMatchesAny(t,a.u6.CONTENT_QUOTA_EXCEPTION)?"QUOTA":"UNKNOWN";return{key:i,variables:r}}static#e=this.\u0275fac=function(n){return new(n||o)(e.Y36(h.W9),e.Y36(I.Y),e.Y36(a.xE),e.Y36(N.sX),e.Y36(A.H),e.Y36(f.sK))};static#t=this.\u0275cmp=e.Xpm({type:o,selectors:[["es-file-upload-progress-dialog"]],viewQuery:function(n,i){if(1&n&&e.Gf(S,5),2&n){let r;e.iGM(r=e.CRH())&&(i.existingFilesRef=r.first)}},decls:3,vars:1,consts:[["class","group",4,"ngFor","ngForOf"],["existingFiles",""],[1,"group"],[1,"icon"],[1,"material-icons"],[1,"center"],[1,"fileName"],["class","loading",4,"ngIf"],["class","progress",4,"ngIf"],[1,"info"],["class","info-error",4,"ngIf"],[4,"ngIf"],[1,"right"],["class","done success",4,"ngIf"],["class","done failed",4,"ngIf"],[1,"loading"],[1,"progress"],[1,"determinate"],[1,"info-error"],[1,"size"],[1,"done","success"],[1,"done","failed"],[1,"existing-radio-group",3,"ngModel","ngModelChange"],[1,"existing-radio-button",3,"value"]],template:function(n,i){1&n&&(e.YNc(0,Q,15,9,"div",0),e.YNc(1,J,7,9,"ng-template",null,1,e.W1O)),2&n&&e.Q6J("ngForOf",i.progress)},dependencies:[m.sg,m.O5,d.ar,C.JJ,C.On,O.VQ,O.U0,f.X$,d.WF,U],styles:[".loading[_ngcontent-%COMP%]{margin:0 10px}.loading[_ngcontent-%COMP%] > div[_ngcontent-%COMP%]{display:flex}.group[_ngcontent-%COMP%]{width:100%;display:flex;margin-bottom:10px}.group[_ngcontent-%COMP%]   .icon[_ngcontent-%COMP%]{color:#aaa;margin-top:5px}.group[_ngcontent-%COMP%]   .center[_ngcontent-%COMP%]{flex-direction:column;flex-grow:1}.group[_ngcontent-%COMP%]   .center[_ngcontent-%COMP%]   .fileName[_ngcontent-%COMP%]{word-break:break-all;padding-bottom:4px;height:1.5em;overflow:hidden}.group[_ngcontent-%COMP%]   .center[_ngcontent-%COMP%]   .fileName[_ngcontent-%COMP%], .group[_ngcontent-%COMP%]   .center[_ngcontent-%COMP%]   .info[_ngcontent-%COMP%]{padding-left:10px}.group[_ngcontent-%COMP%]   .center[_ngcontent-%COMP%]   .info[_ngcontent-%COMP%]{font-size:8pt;font-weight:700;padding-top:2px;min-height:1.3rem}.group[_ngcontent-%COMP%]   .center[_ngcontent-%COMP%]   .info[_ngcontent-%COMP%]   .size[_ngcontent-%COMP%]{font-weight:400;padding-left:.5em;color:var(--textLight)}.group[_ngcontent-%COMP%] > div[_ngcontent-%COMP%]{display:flex}.group[_ngcontent-%COMP%]   .right[_ngcontent-%COMP%]{justify-content:flex-end;align-items:center;width:80px}.group[_ngcontent-%COMP%]   .done[_ngcontent-%COMP%]{color:var(--primary)}.group[_ngcontent-%COMP%]   .success[_ngcontent-%COMP%]{color:#40bf8e}.group[_ngcontent-%COMP%]   .failed[_ngcontent-%COMP%]{color:#cd2457}.group[_ngcontent-%COMP%]   .progress[_ngcontent-%COMP%]{width:100%;margin:0 10px;background-color:var(--palette-primary-100);position:relative;height:4px;border-radius:2px;overflow:hidden}.group[_ngcontent-%COMP%]   .progress[_ngcontent-%COMP%]   .determinate[_ngcontent-%COMP%]{position:absolute;top:0;left:0;bottom:0;background-color:var(--primary);transition:width .3s linear}.groupColumn[_ngcontent-%COMP%]{flex-direction:column}.existing-radio-group[_ngcontent-%COMP%]{display:flex;flex-direction:column;margin:10px 0;align-items:flex-start}.existing-radio-button[_ngcontent-%COMP%]{margin:3px}"]})}return o})(),K=(()=>{class o{static#e=this.\u0275fac=function(n){return new(n||o)};static#t=this.\u0275mod=e.oAB({type:o});static#o=this.\u0275inj=e.cJS({imports:[E.m]})}return o})()}}]);